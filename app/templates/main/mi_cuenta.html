{% extends "base.html" %}

{% block title %}Control Patrimonial - Mi Cuenta{% endblock %}

{% block content %}
<div class="container-fluid mt-2">
    <!-- Encabezado Principal -->
    <div class="d-flex justify-content-between align-items-center mb-2 p-2 rounded" style="background-color: #e9ecef;">
        <h5 class="mb-0 fw-bold text-dark" style="font-size: 0.95rem;">Mi Cuenta</h5>
        <a href="{{ url_for('main.dashboard') }}" class="btn btn-outline-secondary btn-sm" style="font-size: 0.8rem; padding: 5px 10px;">
            <i class="bi bi-arrow-left me-1"></i>Volver
        </a>
    </div>

    <!-- Información de la Cuenta -->
    <div class="card shadow-sm border-0">
        <div class="card-header bg-light p-2">
            <h6 class="mb-0 fw-bold text-dark" style="font-size: 0.85rem;">Información Personal</h6>
        </div>
        <div class="card-body p-3">
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label small fw-bold" style="font-size: 0.8rem;">Usuario:</label>
                        <p class="form-control-plaintext" style="font-size: 0.9rem;">{{ usuario.username or usuario.usuario }}</p>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label small fw-bold" style="font-size: 0.8rem;">Nombre Completo:</label>
                        <p class="form-control-plaintext" style="font-size: 0.9rem;">{{ usuario.nombre }}</p>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label small fw-bold" style="font-size: 0.8rem;">Rol:</label>
                        <p class="form-control-plaintext" style="font-size: 0.9rem;">
                            <span class="badge bg-info">{{ usuario.rol }}</span>
                        </p>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label small fw-bold" style="font-size: 0.8rem;">Estado:</label>
                        <p class="form-control-plaintext" style="font-size: 0.9rem;">
                            {% if usuario.activo == 1 or usuario.activo == True %}
                            <span class="badge bg-success">Activo</span>
                            {% else %}
                            <span class="badge bg-danger">Inactivo</span>
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cambiar Contraseña -->
    <div class="card shadow-sm border-0 mt-3">
        <div class="card-header bg-light p-2">
            <h6 class="mb-0 fw-bold text-dark" style="font-size: 0.85rem;">Cambiar Contraseña</h6>
        </div>
        <div class="card-body p-3">
            <form id="formCambiarPassword">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="inputPasswordActual" class="form-label small" style="font-size: 0.8rem;">Contraseña Actual:</label>
                            <input type="password" class="form-control form-control-sm" id="inputPasswordActual" required style="font-size: 0.85rem;">
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="inputPasswordNueva" class="form-label small" style="font-size: 0.8rem;">Contraseña Nueva:</label>
                            <input type="password" class="form-control form-control-sm" id="inputPasswordNueva" required style="font-size: 0.85rem;">
                            <small class="text-muted" style="font-size: 0.7rem;">Mínimo 6 caracteres</small>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="inputPasswordConfirma" class="form-label small" style="font-size: 0.8rem;">Confirmar Contraseña:</label>
                            <input type="password" class="form-control form-control-sm" id="inputPasswordConfirma" required style="font-size: 0.85rem;">
                        </div>
                    </div>
                </div>

                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary btn-sm" style="font-size: 0.8rem; padding: 6px 16px;">
                        <i class="bi bi-check-circle me-1"></i>Cambiar Contraseña
                    </button>
                    <a href="{{ url_for('main.dashboard') }}" class="btn btn-secondary btn-sm" style="font-size: 0.8rem; padding: 6px 16px;">
                        <i class="bi bi-x-circle me-1"></i>Cancelar
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('formCambiarPassword').addEventListener('submit', async function(e) {
        e.preventDefault();

        const passwordActual = document.getElementById('inputPasswordActual').value;
        const passwordNueva = document.getElementById('inputPasswordNueva').value;
        const passwordConfirma = document.getElementById('inputPasswordConfirma').value;

        // Validaciones locales
        if (!passwordActual || !passwordNueva || !passwordConfirma) {
            alert('Todos los campos son requeridos');
            return;
        }

        if (passwordNueva.length < 6) {
            alert('La contraseña debe tener al menos 6 caracteres');
            return;
        }

        if (passwordNueva !== passwordConfirma) {
            alert('Las contraseñas nuevas no coinciden');
            return;
        }

        try {
            // Obtener CSRF token
            const csrfToken = document.querySelector('input[name="csrf_token"]')?.value ||
                             document.querySelector('meta[name="csrf-token"]')?.content;

            console.log('Enviando solicitud de cambio de contraseña...');
            console.log('URL:', '{{ url_for("auth.cambiar_contrasena") }}');
            console.log('CSRF Token presente:', !!csrfToken);

            const response = await fetch('{{ url_for("auth.cambiar_contrasena") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrfToken || ''
                },
                body: new URLSearchParams({
                    'csrf_token': csrfToken || '',
                    'contrasena_actual': passwordActual,
                    'contrasena_nueva': passwordNueva,
                    'contrasena_confirma': passwordConfirma
                }),
                redirect: 'follow'
            });

            console.log('Status:', response.status);
            console.log('OK:', response.ok);

            // Obtener respuesta como texto primero para debugging
            const responseText = await response.text();
            console.log('Response text:', responseText);

            // Intentar parsear como JSON
            let data;
            try {
                data = JSON.parse(responseText);
            } catch (e) {
                console.error('Error al parsear JSON:', e);
                alert('Error del servidor: respuesta no válida\n\nRespuesta recibida: ' + responseText.substring(0, 200));
                return;
            }

            console.log('Data:', data);

            if (response.ok && data.success) {
                alert(data.message || 'Contraseña cambiada exitosamente');
                // Limpiar formulario
                document.getElementById('inputPasswordActual').value = '';
                document.getElementById('inputPasswordNueva').value = '';
                document.getElementById('inputPasswordConfirma').value = '';
                setTimeout(() => {
                    location.href = '{{ url_for("main.dashboard") }}';
                }, 1000);
            } else {
                const errorMsg = data.error || 'Error al cambiar la contraseña';
                console.error('Error:', errorMsg);
                alert(errorMsg);
            }
        } catch (error) {
            console.error('Exception:', error);
            alert('Error: ' + error.message + '\n\nRevisa la consola del navegador para más detalles');
        }
    });
});
</script>
{% endblock %}
