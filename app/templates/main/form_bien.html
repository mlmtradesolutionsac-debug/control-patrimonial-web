{% extends "base.html" %}

{% block title %}{{ title }} - Inventario{% endblock %}

{% block content %}
<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<style>
    .select2-container .select2-selection--single {
        height: 32px !important;
        font-size: 0.8rem !important;
    }

    .select2-container .select2-selection--single .select2-selection__rendered {
        line-height: 32px !important;
        padding-left: 6px !important;
    }

    .select2-container .select2-selection--single .select2-selection__arrow {
        height: 32px !important;
        right: 4px !important;
    }

    .select2-dropdown {
        font-size: 0.8rem !important;
    }

    .select2-search__field {
        font-size: 0.8rem !important;
    }
</style>
<div class="row justify-content-center mt-2">
    <div class="col-md-7 col-lg-6">
        <div class="card shadow">
            <div class="card-header bg-primary text-white p-1">
                <h5 class="mb-0" style="font-size: 0.95rem;">{{ title }}</h5>
            </div>
            <div class="card-body p-1">
                {% if not is_admin %}
                <div class="alert alert-warning small p-2 mb-2" style="font-size: 0.75rem;">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    <strong>锔 CUIDADO:</strong> Cualquier modificaci贸n a c贸digo patrimonial, c贸digo de barras y serie ser谩 registrada en auditor铆a.
                </div>
                {% endif %}
                <form method="post">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />

                    <!-- CAMPOS PRINCIPALES (Requeridos) -->
                    <div class="bg-light p-2 rounded mb-2" style="border-left: 4px solid #0d6efd;">
                        <h6 class="fw-bold mb-2" style="font-size: 0.85rem; color: #0d6efd;"> Informaci贸n Principal</h6>

                        <!-- Fila 1: Sede y Dependencia -->
                        <div class="row mb-2 g-1">
                            <div class="col-md-6">
                                <label for="sede_id" class="form-label small fw-bold"
                                    style="font-size: 0.75rem; margin-bottom: 2px;">Sede *</label>
                                <select class="form-select form-select-sm" id="sede_id" name="sede" required
                                    style="font-size: 0.8rem;">
                                    <option value="">Seleccione sede</option>
                                    {% for s in sedes %}
                                    <option value="{{ s.id }}" {% if bien and bien.sede_id==s.id %}selected{% endif %}>{{
                                        s.nombre }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="unidad_id" class="form-label small fw-bold"
                                    style="font-size: 0.75rem; margin-bottom: 2px;">Dependencia *</label>
                                <select class="form-select form-select-sm select2-dependencia" id="unidad_id"
                                    name="dependencia" required style="font-size: 0.8rem; width: 100%;">
                                    <option value="">Seleccione dependencia</option>
                                    {% for u in dependencias %}
                                    <option value="{{ u.id }}" {% if bien and bien.unidad_id==u.id %}selected{% endif %}
                                        data-nombre="{{ u.nombre.lower() }}">{{
                                    u.nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <!-- Fila 2: Responsable -->
                    <div class="mb-2">
                        <label for="responsable" class="form-label small fw-bold"
                            style="font-size: 0.75rem; margin-bottom: 2px;">Responsable (Opcional)</label>
                        <select class="form-select form-select-sm select2-responsable" id="responsable"
                            name="responsable" style="font-size: 0.8rem; width: 100%;">
                            <option value="">Seleccione responsable</option>
                            {% for resp in responsables %}
                            <option value="{{ resp }}" {% if bien and bien.responsable==resp %}selected{% endif %}>{{
                                resp }}</option>
                            {% endfor %}
                        </select>
                        <small class="text-muted" style="font-size: 0.7rem; display: block; margin-top: 2px;">O crea uno nuevo desde el m贸dulo Responsables</small>
                    </div>
                    </div>

                    <!-- CAMPOS ADICIONALES (Opcionales - Colapsables) -->
                    <div class="accordion mb-2" id="accordionOpcionales">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#collapseOpcionales" aria-expanded="false"
                                    aria-controls="collapseOpcionales" style="font-size: 0.85rem; color: #0d6efd; font-weight: bold;">
                                    <i class="bi bi-chevron-down me-2"></i> Registro de Bien Patrimonial
                                </button>
                            </h2>
                            <div id="collapseOpcionales" class="accordion-collapse collapse"
                                data-bs-parent="#accordionOpcionales">
                                <div class="accordion-body p-2" style="font-size: 0.8rem;">

                                    <!-- C贸digo Patrimonial y Denominaci贸n -->
                                    <div class="row mb-2 g-1">
                                        <div class="col-md-6">
                                            <label for="codigo_patrimonial" class="form-label small"
                                                style="font-size: 0.75rem; margin-bottom: 2px;">C贸digo {% if not is_admin %}<span
                                                    class="badge bg-info text-white" style="font-size: 0.65rem;">Editable</span>{%
                                                endif %}</label>
                                            <input type="text" class="form-control form-control-sm" id="codigo_patrimonial"
                                                name="codigo_patrimonial" value="{{ bien.codigo_patrimonial if bien else '' }}"
                                                placeholder="Ej: S/C" style="font-size: 0.8rem;">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="denominacion" class="form-label small"
                                                style="font-size: 0.75rem; margin-bottom: 2px;">Denominaci贸n</label>
                                            <input type="text" class="form-control form-control-sm" id="denominacion"
                                                name="denominacion" value="{{ bien.denominacion if bien else '' }}"
                                                style="font-size: 0.8rem;">
                                        </div>
                                    </div>

                                    <!-- C贸digo de Barras y Descripci贸n -->
                                    <div class="row mb-2 g-1">
                                        <div class="col-md-6">
                                            <label for="cod_barras" class="form-label small"
                                                style="font-size: 0.75rem; margin-bottom: 2px;">C贸digo Barras {% if not is_admin %}<span
                                                    class="badge bg-info text-white" style="font-size: 0.65rem;">Editable</span>{%
                                                endif %}</label>
                                            <input type="text" class="form-control form-control-sm" id="cod_barras" name="cod_barras"
                                                value="{{ bien.cod_barras if bien else '' }}" style="font-size: 0.8rem;">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="descripcion" class="form-label small"
                                                style="font-size: 0.75rem; margin-bottom: 2px;">Descripci贸n</label>
                                            <input type="text" class="form-control form-control-sm" id="descripcion" name="descripcion"
                                                value="{{ bien.descripcion if bien else '' }}"
                                                style="font-size: 0.8rem;">
                                        </div>
                                    </div>

                                    <!-- Marca y Modelo -->
                                    <div class="row mb-2 g-1">
                                        <div class="col-md-6">
                                            <label for="marca" class="form-label small"
                                                style="font-size: 0.75rem; margin-bottom: 2px;">Marca</label>
                                            <input type="text" class="form-control form-control-sm" id="marca" name="marca"
                                                value="{{ bien.marca if bien else '' }}" style="font-size: 0.8rem;">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="modelo" class="form-label small"
                                                style="font-size: 0.75rem; margin-bottom: 2px;">Modelo</label>
                                            <input type="text" class="form-control form-control-sm" id="modelo" name="modelo"
                                                value="{{ bien.modelo if bien else '' }}" style="font-size: 0.8rem;">
                                        </div>
                                    </div>

                                    <!-- Serie y Estado -->
                                    <div class="row mb-2 g-1">
                                        <div class="col-md-6">
                                            <label for="serie" class="form-label small"
                                                style="font-size: 0.75rem; margin-bottom: 2px;">N掳 serie {% if not is_admin %}<span
                                                    class="badge bg-info text-white" style="font-size: 0.65rem;">Editable</span>{%
                                                endif %}</label>
                                            <input type="text" class="form-control form-control-sm" id="serie" name="serie"
                                                value="{{ bien.serie if bien else '' }}" style="font-size: 0.8rem;">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="estado" class="form-label small"
                                                style="font-size: 0.75rem; margin-bottom: 2px;">Estado</label>
                                            <select class="form-select form-select-sm" id="estado" name="estado"
                                                style="font-size: 0.8rem;">
                                                <option value="">Seleccione</option>
                                                <option value="b" {% if bien and bien.estado in ['b', 'B' , 'Bueno' ] %}selected{% endif
                                                    %}>Bueno</option>
                                                <option value="r" {% if bien and bien.estado in ['r', 'R' , 'Regular' ] %}selected{%
                                                    endif %}>Regular</option>
                                                <option value="m" {% if bien and bien.estado in ['m', 'M' , 'Malo' ] %}selected{% endif
                                                    %}>Malo</option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- Ubicaci贸n -->
                                    <div class="mb-2">
                                        <label for="ubicacion_texto" class="form-label small"
                                            style="font-size: 0.75rem; margin-bottom: 2px;">Ubicaci贸n</label>
                                        <input type="text" class="form-control form-control-sm" id="ubicacion_texto"
                                            name="ubicacion_texto" value="{{ bien.ubicacion_texto if bien else '' }}"
                                            placeholder="Piso 2, Oficina 203" style="font-size: 0.8rem;">
                                    </div>

                                    <!-- Etiquetas CAL -->
                                    <h6 class="fw-bold text-dark mb-2" style="font-size: 0.8rem;">Etiquetas CAL</h6>
                                    <div class="row mb-2 g-1">
                                        <div class="col-6 col-md-4">
                                            <label for="cal_2020" class="form-label small"
                                                style="font-size: 0.7rem; margin-bottom: 2px;">2020</label>
                                            <input type="text" class="form-control form-control-sm" id="cal_2020" name="cal_2020"
                                                value="{{ bien.cal_2020 or '' if bien else '' }}" style="font-size: 0.75rem;">
                                        </div>
                                        <div class="col-6 col-md-4">
                                            <label for="cal_2021" class="form-label small"
                                                style="font-size: 0.7rem; margin-bottom: 2px;">2021</label>
                                            <input type="text" class="form-control form-control-sm" id="cal_2021" name="cal_2021"
                                                value="{{ bien.cal_2021 or '' if bien else '' }}" style="font-size: 0.75rem;">
                                        </div>
                                        <div class="col-6 col-md-4">
                                            <label for="cal_2022" class="form-label small"
                                                style="font-size: 0.7rem; margin-bottom: 2px;">2022</label>
                                            <input type="text" class="form-control form-control-sm" id="cal_2022" name="cal_2022"
                                                value="{{ bien.cal_2022 or '' if bien else '' }}" style="font-size: 0.75rem;">
                                        </div>
                                    </div>
                                    <div class="row mb-2 g-1">
                                        <div class="col-6 col-md-4">
                                            <label for="cal_2023" class="form-label small"
                                                style="font-size: 0.7rem; margin-bottom: 2px;">2023</label>
                                            <input type="text" class="form-control form-control-sm" id="cal_2023" name="cal_2023"
                                                value="{{ bien.cal_2023 or '' if bien else '' }}" style="font-size: 0.75rem;">
                                        </div>
                                        <div class="col-6 col-md-4">
                                            <label for="cal_2024" class="form-label small"
                                                style="font-size: 0.7rem; margin-bottom: 2px;">2024</label>
                                            <input type="text" class="form-control form-control-sm" id="cal_2024" name="cal_2024"
                                                value="{{ bien.cal_2024 or '' if bien else '' }}" style="font-size: 0.75rem;">
                                        </div>
                                        <div class="col-6 col-md-4">
                                            <label for="cal_2025" class="form-label small"
                                                style="font-size: 0.7rem; margin-bottom: 2px;">2025</label>
                                            <input type="text" class="form-control form-control-sm" id="cal_2025" name="cal_2025"
                                                value="{{ bien.cal_2025 or '' if bien else '' }}" style="font-size: 0.75rem;">
                                        </div>
                                    </div>

                                    <!-- Observaciones -->
                                    <div class="mb-2">
                                        <label for="observaciones" class="form-label small"
                                            style="font-size: 0.75rem; margin-bottom: 2px;">Observaciones</label>
                                        <textarea class="form-control form-control-sm" id="observaciones" name="observaciones" rows="1"
                                            style="font-size: 0.75rem;">{{ bien.observaciones if bien else '' }}</textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Botones -->
                    <div class="d-flex justify-content-between mt-2 gap-1 align-items-center">
                        {% if bien and bien.id and is_admin %}
                        <button type="button" class="btn btn-danger btn-sm" id="btnEliminarBien" data-bien-id="{{ bien.id }}"
                            style="font-size: 0.75rem; padding: 3px 8px;">Eliminar</button>
                        {% else %}
                        <div></div>
                        {% endif %}
                        <div class="d-flex gap-1">
                            <a href="{{ url_for('main.dashboard') }}" class="btn btn-secondary btn-sm"
                                style="font-size: 0.75rem; padding: 3px 8px;">Cancelar</a>
                            <button type="submit" class="btn btn-primary btn-sm"
                                style="font-size: 0.75rem; padding: 3px 8px;">Guardar</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- jQuery (requerido para Select2) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="{{ url_for('static', filename='js/form-bien.js') }}"></script>

<script>
document.getElementById('btnEliminarBien')?.addEventListener('click', function() {
    const bienId = this.getAttribute('data-bien-id');
    const confirmacion = confirm('驴Est谩 seguro de que desea eliminar este bien? Esta acci贸n no se puede deshacer.');

    if (confirmacion) {
        fetch(`/bien/${bienId}/eliminar`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('input[name="csrf_token"]')?.value || ''
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Bien eliminado correctamente');
                window.location.href = '/';
            } else {
                alert('Error al eliminar: ' + (data.error || 'Error desconocido'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al eliminar el bien');
        });
    }
});
</script>
{% endblock %}