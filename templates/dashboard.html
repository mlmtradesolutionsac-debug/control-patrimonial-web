{% extends "base.html" %}

{% block title %}Dashboard - Inventario Patrimonial{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Inventario de Bienes Patrimoniales</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <a href="{{ url_for('nuevo_bien') }}" class="btn btn-sm btn-outline-primary">
                <i class="bi bi-plus"></i> Nuevo Bien
            </a>
            <button type="button" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-download"></i> Exportar
            </button>
        </div>
    </div>
</div>

<!-- Filtros de búsqueda -->
<div class="row mb-4">
    <div class="col-md-3">
        <input type="text" class="form-control" id="filtroCodigo" placeholder="Filtrar por código">
    </div>
    <div class="col-md-3">
        <input type="text" class="form-control" id="filtroDescripcion" placeholder="Filtrar por descripción">
    </div>
    <div class="col-md-3">
        <select class="form-select" id="filtroSede">
            <option value="">Todas las sedes</option>
            <!-- Las opciones se cargarán dinámicamente -->
        </select>
    </div>
    <div class="col-md-3">
        <select class="form-select" id="filtroEstado">
            <option value="">Todos los estados</option>
            <option value="b">Bueno</option>
            <option value="r">Regular</option>
            <option value="m">Malo</option>
        </select>
    </div>
</div>

<!-- Tabla de bienes -->
<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead class="table-dark">
            <tr>
                <th>Código Patrimonial</th>
                <th>Código de Barras</th>
                <th>Denominación</th>
                <th>Marca</th>
                <th>Serie</th>
                <th>Modelo</th>
                <th>Usuario Responsable</th>
                <th>Sede</th>
                <th>Dependencia</th>
                <th>Estado</th>
                <th>Verificado</th>
                <th>Cal 2025</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for bien in bienes %}
            <tr>
                <td>{{ bien.codigo_patrimonial }}</td>
                <td>{{ bien.codigo_barras or '' }}</td>
                <td>{{ bien.denominacion or '' }}</td>
                <td>{{ bien.marca or '' }}</td>
                <td>{{ bien.serie or '' }}</td>
                <td>{{ bien.modelo or '' }}</td>
                <td>{{ bien.usuario_responsable or '' }}</td>
                <td>{{ bien.sede or '' }}</td>
                <td>{{ bien.dependencia or '' }}</td>
                <td>
                    <span class="badge
                        {% if bien.estado == 'b' %}bg-success
                        {% elif bien.estado == 'r' %}bg-warning
                        {% elif bien.estado == 'm' %}bg-danger
                        {% else %}bg-secondary{% endif %}">
                        {% if bien.estado == 'b' %}Bueno
                        {% elif bien.estado == 'r' %}Regular
                        {% elif bien.estado == 'm' %}Malo
                        {% else %}Desconocido{% endif %}
                    </span>
                </td>
                <td>{{ bien.verificado or '' }}</td>
                <td>{{ bien.cal_2025 or '' }}</td>
                <td>
                    <div class="btn-group" role="group">
                        <a href="{{ url_for('editar_bien', id=bien.id) }}" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-pencil"></i>
                        </a>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Paginación -->
<nav aria-label="Navegación de páginas">
    <ul class="pagination justify-content-center">
        <li class="page-item disabled">
            <a class="page-link" href="#" tabindex="-1">Anterior</a>
        </li>
        <li class="page-item active"><a class="page-link" href="#">1</a></li>
        <li class="page-item"><a class="page-link" href="#">2</a></li>
        <li class="page-item"><a class="page-link" href="#">3</a></li>
        <li class="page-item">
            <a class="page-link" href="#">Siguiente</a>
        </li>
    </ul>
</nav>

{% endblock %}

{% block scripts %}
<script>
    // Filtrado en tiempo real de la tabla
    document.addEventListener('DOMContentLoaded', function() {
        const tabla = document.querySelector('tbody');
        const filas = tabla.querySelectorAll('tr');
        
        // Función para filtrar filas
        function filtrarFilas() {
            const filtroCodigo = document.getElementById('filtroCodigo').value.toLowerCase();
            const filtroDescripcion = document.getElementById('filtroDescripcion').value.toLowerCase();
            const filtroSede = document.getElementById('filtroSede').value.toLowerCase();
            const filtroEstado = document.getElementById('filtroEstado').value;
            
            filas.forEach(function(fila) {
                const celdas = fila.querySelectorAll('td');
                const codigo = celdas[0].textContent.toLowerCase();
                const descripcion = celdas[1].textContent.toLowerCase();
                const sede = celdas[6].textContent.toLowerCase();
                const estado = celdas[5].querySelector('.badge').textContent.toLowerCase();
                
                const coincideCodigo = codigo.includes(filtroCodigo);
                const coincideDescripcion = descripcion.includes(filtroDescripcion);
                const coincideSede = filtroSede === '' || sede.includes(filtroSede);
                const coincideEstado = filtroEstado === '' || estado.includes(filtroEstado);
                
                if (coincideCodigo && coincideDescripcion && coincideSede && coincideEstado) {
                    fila.style.display = '';
                } else {
                    fila.style.display = 'none';
                }
            });
        }
        
        // Agregar eventos a los campos de filtrado
        document.getElementById('filtroCodigo').addEventListener('input', filtrarFilas);
        document.getElementById('filtroDescripcion').addEventListener('input', filtrarFilas);
        document.getElementById('filtroSede').addEventListener('change', filtrarFilas);
        document.getElementById('filtroEstado').addEventListener('change', filtrarFilas);
        
        // Llenar opciones del filtro de sede dinámicamente
        const sedes = new Set();
        filas.forEach(function(fila) {
            const sede = fila.querySelectorAll('td')[6].textContent;
            if (sede) {
                sedes.add(sede);
            }
        });
        
        const filtroSede = document.getElementById('filtroSede');
        sedes.forEach(function(sede) {
            const option = document.createElement('option');
            option.value = sede.toLowerCase();
            option.textContent = sede;
            filtroSede.appendChild(option);
        });
    });
</script>
{% endblock %}